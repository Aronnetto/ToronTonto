#include <Servo.h>

const int sensorLDR = A3; // Pin donde est치 conectado OUT del sensor
const int ledPinR = 13;   // LED incorporado del Arduino
const int ledPinA = 7;

int rojo=0;
int azul=0;
int lectura=0;

int sensorState;
int sensorIR = 6; // Pin donde est치 conectado OUT del sensor pelota
int valorSensorPelota = 0;
 
float error;
float errorant=0;
float correccion=0;
float integral=0;
float diferencial=0;

bool tengoPelota;

Servo servoizq;
Servo servoder;
Servo garra;
Servo brazo;

const int T1 = 10;
const int E1 = 11;

long dis;

void setup() {
  Serial.begin(9600);
  pinMode(T1, OUTPUT);
  pinMode(E1, INPUT);
  digitalWrite(T1, LOW);
  digitalWrite(E1, LOW);
  pinMode(sensorIR, INPUT);
  pinMode(ledPinR, OUTPUT);
  pinMode(ledPinA, OUTPUT);
  digitalWrite(ledPinR, LOW);
  digitalWrite(ledPinA, LOW);
  servoder.attach(4);
  servoizq.attach(5);
  garra.attach(9);
  brazo.attach(8);
  pinMode(sensorLDR, INPUT);
  servoder.write(0);
  servoizq.write(0);
  delay(3000);
  garra.write(80); // giro hacia afuera y queda pronta para agarrar
  delay(250);     // 
  garra.write(90); //al inicuar el programa hay que dejar la garra cerrada
  delay(1000);
  brazo.write(180);
  tengoPelota=0;
}

void loop(){ 
  Distancia();
  //Serial.println("");
     error= -3*analogRead(A7) + -2*analogRead(A6) + -1.5*analogRead(A5) + 1.5*analogRead(A2) + 2*analogRead(A1) + 3*analogRead(A0);

   //Serial.println(error);
   diferencial=error-errorant;
   integral = error/10+integral;
   errorant=error;
   correccion= (error/15) + 1*diferencial/3.8 + 0.02*(integral/32);
   seguir(10, correccion);
   Serial.println(correccion);


  sensorState = analogRead(sensorLDR);
  valorSensorPelota = digitalRead(sensorIR);
  if ((valorSensorPelota ==  0) && (tengoPelota == 0)){
    delay(150);
    parar();
    delay(1000);
    garra.write(100);
    delay(1000);
    digitalWrite(ledPinR, HIGH);
    delay(1000);
    rojo = (analogRead(sensorLDR));
    Serial.println(rojo);
    delay(1000);
    digitalWrite(ledPinR, LOW);
    delay(1000);
    digitalWrite(ledPinA, HIGH);
    azul = (analogRead(sensorLDR) + 200);
    Serial.println(azul);
    delay(1000);
    digitalWrite(ledPinA, LOW);
    //lectura = azul + rojo;
    valorSensorPelota = digitalRead(sensorIR);
    
     if (azul > rojo) {
      delay(1000);
      digitalWrite(ledPinR, LOW);
      digitalWrite(ledPinA, LOW);
      Levantar();
     }
     else {
      tengoPelota = 1;
      Distancia();
     }
    //Serial.println(tengoPelota);
    
    }
  
  // chequeo de distancia al costado
    Distancia();  
    if((dis <= 26) && (dis > 20) && (tengoPelota == 1)){
        // prisma 
        tengoPelota = 0;
        tirarPrisma();
         
     //if (tengoPelota) {
      // tirarPrisma(); 
     //} 
    //} 
   
   /*if (dis <= 17){
      while (dis <= 17)  {
            // portico
        //adelante(10); 
        Distancia();
      }
  // al salir del portico tirar la pelota
     if (tengoPelota) {
       tirarPortico(); 
     }*/ 
    
   //}
    
  // Seguidor de linas

}
}



void Levantar (){ //hay que cambiarle para que solo levante etc.
   brazo.write(0); //sube hasta posici칩n deseada, pot 60 durante 0,8 seg
   delay(600);
   garra.write(90); //esperamos a que el brazo suba 
   delay(600);
   garra.write(80); //giro hacia afuera y queda pronta para agarrar
   delay(250);
   garra.write(90);
   brazo.write(180); // baja para agarrar de nuevo, pot 120 durante 0,6 seg
   delay(400);
}

void seguir(int v, float correccion) {
  servoder.write(parallax(-v - correccion));
  servoizq.write(parallax(v -correccion));
}

void izquierda(int v) {
  servoder.write(parallax(-v ));
  servoizq.write(parallax(-v));

}

void derecha(int v) {
  servoder.write(parallax(v));
  servoizq.write(parallax(v));
}

void atras(int v) {
  servoder.write(parallax(v));
  servoizq.write(parallax(-v));
}

void parar() {
  servoder.write(parallax(0));
  servoizq.write(parallax(0));
 
}

void adelante(int v) {
  servoder.write(parallax(-v));
  servoizq.write(parallax(v));
}

int parallax(float velocidad){  //velocidad es un par치metro que tenemos que setear entre -100 y 100. 
    return int(1500+(velocidad/100)*250);
     }

void tirarPrisma(){ 
  //tirar para el prisma 
    
    //while (digitalRead(sensorPin))
    { 
      adelante(20);
      delay(1000);
      parar();
      delay(500);
      garra.write(80);
      delay(250);
      garra.write(90);
      izquierda(40);// 90 a 180
      delay(500);
      parar();
      delay(1000);
      derecha(20);
      delay(500);
      adelante(20);
      delay(750);
      digitalWrite(ledPinR, LOW);
      digitalWrite(ledPinA, LOW);
      Distancia();
    }

}


void Distancia() {
  long t;
  digitalWrite(T1, HIGH);
  delayMicroseconds(10);
  digitalWrite(T1,LOW);
  t = pulseIn(E1, HIGH);
  dis = t/59;

  t = pulseIn(E1, HIGH);
  dis = t/59;
}
